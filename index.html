<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšå£«è®ºæ–‡å†™ä½œè¿›åº¦ç”˜ç‰¹å›¾</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .add-btn {
            background: #27ae60;
        }
        .add-btn:hover {
            background: #229954;
        }
        .delete-btn {
            background: #e74c3c;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .export-btn {
            background: #9b59b6;
        }
        .export-btn:hover {
            background: #8e44ad;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        tr:hover {
            background: #e8f4f8;
        }
        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="number"] {
            width: 80px;
        }
        select {
            cursor: pointer;
        }
        .chart-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #fafafa;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-title {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .stat-value {
            color: #2c3e50;
            font-size: 24px;
            font-weight: bold;
        }
        .checkbox-cell {
            text-align: center;
        }
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š åšå£«è®ºæ–‡å†™ä½œè¿›åº¦ç”˜ç‰¹å›¾</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">æ€»ä»»åŠ¡æ•°</div>
                <div class="stat-value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">å·²å®Œæˆ</div>
                <div class="stat-value" id="completedTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">è¿›è¡Œä¸­</div>
                <div class="stat-value" id="inProgressTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">å¹³å‡è¿›åº¦</div>
                <div class="stat-value" id="avgProgress">0%</div>
            </div>
        </div>

        <div class="controls">
            <button class="add-btn" onclick="addTask()">â• æ·»åŠ ä»»åŠ¡</button>
            <button class="delete-btn" onclick="deleteSelected()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            <button onclick="updateChart()">ğŸ”„ æ›´æ–°ç”˜ç‰¹å›¾</button>
            <button class="export-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button onclick="importData()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
            <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">
        </div>

        <div class="table-wrapper">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell">é€‰æ‹©</th>
                        <th>ç« èŠ‚</th>
                        <th>å¼€å§‹æ—¥æœŸ</th>
                        <th>ç»“æŸæ—¥æœŸ</th>
                        <th>ä»»åŠ¡</th>
                        <th>ç›®æ ‡æˆæœ</th>
                        <th>è¿›åº¦(%)</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                </tbody>
            </table>
        </div>

        <div class="chart-container">
            <div id="ganttChart"></div>
        </div>
    </div>

    <script>
        // åˆå§‹æ•°æ® - åŸºäºæ‚¨çš„Excelæ–‡ä»¶
        let tasks = [
            {
                chapter: "ğŸ“˜ Ch.4 Quick Capture Paper",
                startDate: "2025-11-04",
                endDate: "2025-11-16",
                task: "æ˜ç¡®ç›®æ ‡æœŸåˆŠ, æ’°å†™å¼•è¨€, ç ”ç©¶æ–¹æ³•, ç»“æœåˆ†æ, è®¨è®ºä¸ç»“è®º",
                deliverable: "å®Œæˆè®ºæ–‡å„éƒ¨åˆ†åˆç¨¿ä¸ä¿®è®¢",
                progress: 0,
                status: "è¿›è¡Œä¸­"
            },
            {
                chapter: "ğŸ¨ Ch.5 Design Jam Paper",
                startDate: "2025-11-18",
                endDate: "2025-11-30",
                task: "æ’°å†™å¼•è¨€ï¼ˆé’å¹´è§†è§’ï¼‰, å·¥ä½œåŠè®¾è®¡, ç»“æœåˆ†æ, æ•™è‚²å¯ç¤ºè®¨è®º",
                deliverable: "å®Œæˆè®ºæ–‡å„éƒ¨åˆ†åˆç¨¿ä¸ä¿®è®¢",
                progress: 0,
                status: "æœªå¼€å§‹"
            },
            {
                chapter: "ğŸ“± Ch.6 App Design Paper",
                startDate: "2025-12-02",
                endDate: "2025-12-14",
                task: "æ’°å†™å¼•è¨€, ç”¨æˆ·ä¸­å¿ƒè®¾è®¡æµç¨‹, æµ‹è¯•ç»“æœ, è®¾è®¡åŸåˆ™è®¨è®º",
                deliverable: "å®Œæˆè®ºæ–‡å„éƒ¨åˆ†åˆç¨¿ä¸ä¿®è®¢",
                progress: 0,
                status: "æœªå¼€å§‹"
            },
            {
                chapter: "ğŸ§­ Ch.3 Approach",
                startDate: "2025-12-16",
                endDate: "2025-12-18",
                task: "æ’°å†™ç ”ç©¶æ¡†æ¶, ç†è®ºæ•´åˆ, ç»˜åˆ¶æ–¹æ³•æ¡†æ¶å›¾",
                deliverable: "å®Œæˆæ–¹æ³•è®ºç« èŠ‚",
                progress: 0,
                status: "æœªå¼€å§‹"
            },
            {
                chapter: "ğŸ“š Ch.2 Literature Review",
                startDate: "2025-12-19",
                endDate: "2025-12-22",
                task: "çƒ­å¥åº·é£é™©ç»¼è¿°, TPB/Foggç†è®º, é¢„è­¦ç³»ç»Ÿç ”ç©¶",
                deliverable: "å®Œæˆæ–‡çŒ®ç»¼è¿°ç« èŠ‚",
                progress: 0,
                status: "æœªå¼€å§‹"
            },
            {
                chapter: "ğŸ§± Ch.1 Introduction",
                startDate: "2025-12-23",
                endDate: "2025-12-26",
                task: "ç ”ç©¶èƒŒæ™¯, ç ”ç©¶æ„ä¹‰ä¸ç›®æ ‡, ç ”ç©¶é—®é¢˜ä¸å‡è®¾",
                deliverable: "å®Œæˆå¼•è¨€ç« èŠ‚",
                progress: 0,
                status: "æœªå¼€å§‹"
            },
            {
                chapter: "ğŸ”¬ Ch.7 Field Test (Method)",
                startDate: "2025-12-27",
                endDate: "2025-12-31",
                task: "å®éªŒè®¾è®¡, æµ‹è¯•æ¡ä»¶, æ•°æ®æ”¶é›†ä¸åˆ†ææ–¹æ³•",
                deliverable: "å®Œæˆå®åœ°æµ‹è¯•æ–¹æ³•ç« èŠ‚",
                progress: 0,
                status: "æœªå¼€å§‹"
            }
        ];

        function renderTable() {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="checkbox-cell"><input type="checkbox" data-index="${index}"></td>
                    <td><input type="text" value="${task.chapter}" onchange="updateTask(${index}, 'chapter', this.value)"></td>
                    <td><input type="date" value="${task.startDate}" onchange="updateTask(${index}, 'startDate', this.value)"></td>
                    <td><input type="date" value="${task.endDate}" onchange="updateTask(${index}, 'endDate', this.value)"></td>
                    <td><input type="text" value="${task.task}" onchange="updateTask(${index}, 'task', this.value)"></td>
                    <td><input type="text" value="${task.deliverable}" onchange="updateTask(${index}, 'deliverable', this.value)"></td>
                    <td><input type="number" min="0" max="100" value="${task.progress}" onchange="updateTask(${index}, 'progress', this.value)"></td>
                    <td>
                        <select onchange="updateTask(${index}, 'status', this.value)">
                            <option value="æœªå¼€å§‹" ${task.status === 'æœªå¼€å§‹' ? 'selected' : ''}>æœªå¼€å§‹</option>
                            <option value="è¿›è¡Œä¸­" ${task.status === 'è¿›è¡Œä¸­' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ" ${task.status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                            <option value="å»¶æœŸ" ${task.status === 'å»¶æœŸ' ? 'selected' : ''}>å»¶æœŸ</option>
                        </select>
                    </td>
                `;
            });
            
            updateStats();
        }

        function updateTask(index, field, value) {
            if (field === 'progress') {
                value = Math.max(0, Math.min(100, parseInt(value) || 0));
                // è‡ªåŠ¨æ›´æ–°çŠ¶æ€
                if (value === 0) {
                    tasks[index].status = 'æœªå¼€å§‹';
                } else if (value === 100) {
                    tasks[index].status = 'å·²å®Œæˆ';
                } else {
                    tasks[index].status = 'è¿›è¡Œä¸­';
                }
            }
            tasks[index][field] = value;
            renderTable();
            updateChart();
        }

        function addTask() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            tasks.push({
                chapter: "æ–°ç« èŠ‚",
                startDate: today,
                endDate: nextWeek,
                task: "æ–°ä»»åŠ¡",
                deliverable: "å¾…å®š",
                progress: 0,
                status: "æœªå¼€å§‹"
            });
            
            renderTable();
            updateChart();
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
            
            indicesToDelete.forEach(index => {
                tasks.splice(index, 1);
            });
            
            renderTable();
            updateChart();
        }

        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'å·²å®Œæˆ').length;
            const inProgress = tasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
            const avgProgress = tasks.length > 0 ? 
                Math.round(tasks.reduce((sum, t) => sum + (parseInt(t.progress) || 0), 0) / tasks.length) : 0;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }

        function updateChart() {
            const data = [];
            const colors = {
                'æœªå¼€å§‹': '#95a5a6',
                'è¿›è¡Œä¸­': '#3498db',
                'å·²å®Œæˆ': '#27ae60',
                'å»¶æœŸ': '#e74c3c'
            };
            
            // æŒ‰å¼€å§‹æ—¥æœŸæ’åºä»»åŠ¡
            const sortedTasks = [...tasks].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            sortedTasks.forEach((task, index) => {
                const startDate = new Date(task.startDate);
                const endDate = new Date(task.endDate);
                const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
                
                data.push({
                    x: [startDate, endDate],
                    y: [index, index],
                    name: task.chapter,
                    text: `${task.task} (${task.progress}%)`,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: colors[task.status],
                        width: 20
                    },
                    hovertemplate: 
                        '<b>%{text}</b><br>' +
                        'ç« èŠ‚: %{name}<br>' +
                        'å¼€å§‹: %{x[0]|%Y-%m-%d}<br>' +
                        'ç»“æŸ: %{x[1]|%Y-%m-%d}<br>' +
                        'æŒç»­: ' + duration + ' å¤©<br>' +
                        'è¿›åº¦: ' + task.progress + '%<br>' +
                        'çŠ¶æ€: ' + task.status +
                        '<extra></extra>',
                    showlegend: false
                });
                
                // æ·»åŠ è¿›åº¦æ¡
                if (task.progress > 0) {
                    const progressEnd = new Date(startDate.getTime() + (endDate - startDate) * task.progress / 100);
                    data.push({
                        x: [startDate, progressEnd],
                        y: [index, index],
                        type: 'scatter',
                        mode: 'lines',
                        line: {
                            color: '#2ecc71',
                            width: 10
                        },
                        hoverinfo: 'skip',
                        showlegend: false
                    });
                }
            });
            
            const layout = {
                title: {
                    text: 'åšå£«è®ºæ–‡å†™ä½œè¿›åº¦ç”˜ç‰¹å›¾',
                    font: {
                        size: 20,
                        color: '#2c3e50'
                    }
                },
                xaxis: {
                    type: 'date',
                    title: 'æ—¥æœŸ',
                    gridcolor: '#ecf0f1',
                    showgrid: true,
                    zeroline: false,
                    tickformat: '%Y-%m-%d'
                },
                yaxis: {
                    title: 'ä»»åŠ¡',
                    ticktext: sortedTasks.map(t => t.chapter),
                    tickvals: sortedTasks.map((t, i) => i),
                    tickmode: 'array',
                    gridcolor: '#ecf0f1',
                    showgrid: true,
                    zeroline: false
                },
                height: 550,
                margin: {
                    l: 200,
                    r: 40,
                    t: 60,
                    b: 60
                },
                hovermode: 'closest',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#fafafa',
                shapes: [
                    {
                        type: 'line',
                        x0: new Date().toISOString().split('T')[0],
                        x1: new Date().toISOString().split('T')[0],
                        y0: -0.5,
                        y1: tasks.length - 0.5,
                        line: {
                            color: '#e74c3c',
                            width: 2,
                            dash: 'dot'
                        }
                    }
                ],
                annotations: [
                    {
                        x: new Date().toISOString().split('T')[0],
                        y: tasks.length,
                        text: 'ä»Šå¤©',
                        showarrow: true,
                        arrowhead: 2,
                        arrowsize: 1,
                        arrowwidth: 2,
                        arrowcolor: '#e74c3c',
                        ax: 0,
                        ay: -30
                    }
                ]
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
            };
            
            Plotly.newPlot('ganttChart', data, layout, config);
        }

        function exportData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `PhD_Timeline_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        tasks = JSON.parse(e.target.result);
                        renderTable();
                        updateChart();
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsText(file);
            }
        }

        // åˆå§‹åŒ–
        renderTable();
        updateChart();
        
        // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        setInterval(() => {
            localStorage.setItem('phdTasks', JSON.stringify(tasks));
        }, 5000);
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        window.addEventListener('load', () => {
            const savedTasks = localStorage.getItem('phdTasks');
            if (savedTasks) {
                try {
                    tasks = JSON.parse(savedTasks);
                    renderTable();
                    updateChart();
                } catch (e) {
                    console.log('åŠ è½½ä¿å­˜çš„æ•°æ®å¤±è´¥');
                }
            }
        });
    </script>
</body>
</html>
