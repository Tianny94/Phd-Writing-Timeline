<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhD Thesis Writing Timeline - Detailed Gantt Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 10px;
            background: linear-gradient(90deg, #3498db 5px, #ecf0f1 5px);
            border-radius: 5px;
        }
        .view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: #3498db;
            color: white;
        }
        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .add-btn {
            background: #27ae60;
        }
        .add-btn:hover {
            background: #229954;
        }
        .delete-btn {
            background: #e74c3c;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .export-btn {
            background: #9b59b6;
        }
        .export-btn:hover {
            background: #8e44ad;
        }
        .expand-btn {
            background: #f39c12;
        }
        .expand-btn:hover {
            background: #d68910;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        tr.chapter-row {
            background: #e8f6f3;
            font-weight: bold;
        }
        tr.task-row {
            background: white;
        }
        tr.task-row td:first-child {
            padding-left: 40px;
        }
        tr:hover {
            background: #e8f4f8;
        }
        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="number"] {
            width: 80px;
        }
        select {
            cursor: pointer;
        }
        .chart-container {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #fafafa;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #3498db;
        }
        .stat-title {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .stat-value {
            color: #2c3e50;
            font-size: 24px;
            font-weight: bold;
        }
        .checkbox-cell {
            text-align: center;
            width: 40px;
        }
        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .collapse-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            margin-right: 5px;
        }
        .chapter-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .chapter-chart {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .chapter-charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö PhD Thesis Writing Timeline - Detailed Version</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">Total Chapters</div>
                <div class="stat-value" id="totalChapters">7</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Tasks</div>
                <div class="stat-value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Completed Tasks</div>
                <div class="stat-value" id="completedTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Overall Progress</div>
                <div class="stat-value" id="avgProgress">0%</div>
            </div>
        </div>

        <div class="view-controls">
            <button class="view-btn active" onclick="switchView('overview')">üìä Overview</button>
            <button class="view-btn" onclick="switchView('detailed')">üìã Detailed Tasks</button>
            <button class="view-btn" onclick="switchView('chapters')">üìö Chapter View</button>
        </div>

        <div class="controls">
            <button class="add-btn" onclick="addChapter()">‚ûï Add Chapter</button>
            <button class="expand-btn" onclick="expandAll()">üìÇ Expand All</button>
            <button class="expand-btn" onclick="collapseAll()">üìÅ Collapse All</button>
            <button onclick="updateAllCharts()">üîÑ Update Charts</button>
            <button class="export-btn" onclick="exportData()">üì• Export Data</button>
            <button onclick="importData()">üì§ Import Data</button>
            <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">
        </div>

        <!-- Overview View -->
        <div id="overviewView">
            <h2>üìä Chapter Overview Gantt Chart</h2>
            <div class="chart-container">
                <div id="overviewChart"></div>
            </div>
        </div>

        <!-- Detailed View -->
        <div id="detailedView" style="display: none;">
            <h2>üìã Detailed Task List</h2>
            <div class="table-wrapper">
                <table id="taskTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">Select</th>
                            <th>Chapter/Task</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Progress(%)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                    </tbody>
                </table>
            </div>
            <div class="chart-container">
                <div id="detailedChart"></div>
            </div>
        </div>

        <!-- Chapter View -->
        <div id="chaptersView" style="display: none;">
            <h2>üìö Chapter-wise Gantt Charts</h2>
            <div class="chapter-charts" id="chapterCharts">
            </div>
        </div>
    </div>

    <script>
        // Data structure: Chapters and Tasks
        let chapters = [
            {
                id: 'ch4',
                name: 'üìò Ch.4 Quick Capture Paper',
                startDate: '2025-11-04',
                endDate: '2025-11-16',
                progress: 0,
                status: 'In Progress',
                expanded: true,
                tasks: [
                    { name: 'Identify target journal and paper structure', startDate: '2025-11-04', endDate: '2025-11-04', progress: 0, status: 'Not Started' },
                    { name: 'Write introduction: research background and gaps', startDate: '2025-11-05', endDate: '2025-11-05', progress: 0, status: 'Not Started' },
                    { name: 'Write research questions and objectives', startDate: '2025-11-06', endDate: '2025-11-06', progress: 0, status: 'Not Started' },
                    { name: 'Write methods (data sources and participants)', startDate: '2025-11-07', endDate: '2025-11-07', progress: 0, status: 'Not Started' },
                    { name: 'Write methods (data collection and analysis)', startDate: '2025-11-08', endDate: '2025-11-08', progress: 0, status: 'Not Started' },
                    { name: 'Write results (statistics and behavior types)', startDate: '2025-11-09', endDate: '2025-11-10', progress: 0, status: 'Not Started' },
                    { name: 'Write results (key findings and trends)', startDate: '2025-11-11', endDate: '2025-11-11', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion (TPB and Fogg model)', startDate: '2025-11-12', endDate: '2025-11-12', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion (theoretical and practical implications)', startDate: '2025-11-13', endDate: '2025-11-13', progress: 0, status: 'Not Started' },
                    { name: 'Write abstract and conclusion', startDate: '2025-11-14', endDate: '2025-11-14', progress: 0, status: 'Not Started' },
                    { name: 'Revise paper and integrate figures', startDate: '2025-11-15', endDate: '2025-11-15', progress: 0, status: 'Not Started' },
                    { name: 'Check APA format and references', startDate: '2025-11-16', endDate: '2025-11-16', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch5',
                name: 'üé® Ch.5 Design Jam Paper',
                startDate: '2025-11-18',
                endDate: '2025-11-30',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Identify target journal and paper structure', startDate: '2025-11-18', endDate: '2025-11-18', progress: 0, status: 'Not Started' },
                    { name: 'Write introduction: youth perspective and design education', startDate: '2025-11-19', endDate: '2025-11-19', progress: 0, status: 'Not Started' },
                    { name: 'Write research questions and objectives', startDate: '2025-11-20', endDate: '2025-11-20', progress: 0, status: 'Not Started' },
                    { name: 'Write methods: workshop design and process', startDate: '2025-11-21', endDate: '2025-11-21', progress: 0, status: 'Not Started' },
                    { name: 'Write methods: participants and activities', startDate: '2025-11-22', endDate: '2025-11-22', progress: 0, status: 'Not Started' },
                    { name: 'Write results: student understanding and innovation', startDate: '2025-11-23', endDate: '2025-11-24', progress: 0, status: 'Not Started' },
                    { name: 'Write results: design solutions and insights', startDate: '2025-11-25', endDate: '2025-11-25', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion: youth perspective in community design', startDate: '2025-11-26', endDate: '2025-11-26', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion: education and co-creation implications', startDate: '2025-11-27', endDate: '2025-11-27', progress: 0, status: 'Not Started' },
                    { name: 'Write abstract and conclusion', startDate: '2025-11-28', endDate: '2025-11-28', progress: 0, status: 'Not Started' },
                    { name: 'Integrate images and showcase results', startDate: '2025-11-29', endDate: '2025-11-29', progress: 0, status: 'Not Started' },
                    { name: 'Final revision and proofreading', startDate: '2025-11-30', endDate: '2025-11-30', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch6',
                name: 'üì± Ch.6 App Design Paper',
                startDate: '2025-12-02',
                endDate: '2025-12-14',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Identify journal and paper framework', startDate: '2025-12-02', endDate: '2025-12-02', progress: 0, status: 'Not Started' },
                    { name: 'Write introduction: problem background and design goals', startDate: '2025-12-03', endDate: '2025-12-03', progress: 0, status: 'Not Started' },
                    { name: 'Write methods: user-centered design process', startDate: '2025-12-04', endDate: '2025-12-05', progress: 0, status: 'Not Started' },
                    { name: 'Write methods: iterative testing and feedback', startDate: '2025-12-06', endDate: '2025-12-06', progress: 0, status: 'Not Started' },
                    { name: 'Write results: key design modules', startDate: '2025-12-07', endDate: '2025-12-08', progress: 0, status: 'Not Started' },
                    { name: 'Write results: user testing feedback summary', startDate: '2025-12-09', endDate: '2025-12-09', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion: design principles and value', startDate: '2025-12-10', endDate: '2025-12-10', progress: 0, status: 'Not Started' },
                    { name: 'Write discussion: future improvements', startDate: '2025-12-11', endDate: '2025-12-11', progress: 0, status: 'Not Started' },
                    { name: 'Write abstract and conclusion', startDate: '2025-12-12', endDate: '2025-12-12', progress: 0, status: 'Not Started' },
                    { name: 'Integrate UI screenshots and design documentation', startDate: '2025-12-13', endDate: '2025-12-13', progress: 0, status: 'Not Started' },
                    { name: 'Revise paper and format adjustment', startDate: '2025-12-14', endDate: '2025-12-14', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch3',
                name: 'üß≠ Ch.3 Approach',
                startDate: '2025-12-16',
                endDate: '2025-12-18',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Write research framework and theoretical integration', startDate: '2025-12-16', endDate: '2025-12-16', progress: 0, status: 'Not Started' },
                    { name: 'Write research process and phase design', startDate: '2025-12-17', endDate: '2025-12-17', progress: 0, status: 'Not Started' },
                    { name: 'Create research methodology framework diagram', startDate: '2025-12-18', endDate: '2025-12-18', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch2',
                name: 'üìö Ch.2 Literature Review',
                startDate: '2025-12-19',
                endDate: '2025-12-22',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Write heat health risks and vulnerable populations', startDate: '2025-12-19', endDate: '2025-12-19', progress: 0, status: 'Not Started' },
                    { name: 'Write behavior change theories (TPB, Fogg)', startDate: '2025-12-20', endDate: '2025-12-20', progress: 0, status: 'Not Started' },
                    { name: 'Write heat warning systems research', startDate: '2025-12-21', endDate: '2025-12-21', progress: 0, status: 'Not Started' },
                    { name: 'Integrate literature and identify research gaps', startDate: '2025-12-22', endDate: '2025-12-22', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch1',
                name: 'üß± Ch.1 Introduction',
                startDate: '2025-12-23',
                endDate: '2025-12-26',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Write research background and problem statement', startDate: '2025-12-23', endDate: '2025-12-23', progress: 0, status: 'Not Started' },
                    { name: 'Write research significance and objectives', startDate: '2025-12-24', endDate: '2025-12-24', progress: 0, status: 'Not Started' },
                    { name: 'Write research questions and hypotheses', startDate: '2025-12-25', endDate: '2025-12-25', progress: 0, status: 'Not Started' },
                    { name: 'Integrate introduction and chapter connections', startDate: '2025-12-26', endDate: '2025-12-26', progress: 0, status: 'Not Started' }
                ]
            },
            {
                id: 'ch7',
                name: 'üî¨ Ch.7 Field Test (Method)',
                startDate: '2025-12-27',
                endDate: '2025-12-31',
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: [
                    { name: 'Write research objectives and experimental design', startDate: '2025-12-27', endDate: '2025-12-27', progress: 0, status: 'Not Started' },
                    { name: 'Describe experimental environment and test conditions', startDate: '2025-12-28', endDate: '2025-12-28', progress: 0, status: 'Not Started' },
                    { name: 'Write data collection methods (app usage and surveys)', startDate: '2025-12-29', endDate: '2025-12-29', progress: 0, status: 'Not Started' },
                    { name: 'Write data analysis plan', startDate: '2025-12-30', endDate: '2025-12-30', progress: 0, status: 'Not Started' },
                    { name: 'Integrate methods section and tables', startDate: '2025-12-31', endDate: '2025-12-31', progress: 0, status: 'Not Started' }
                ]
            }
        ];

        let currentView = 'overview';

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('overviewView').style.display = view === 'overview' ? 'block' : 'none';
            document.getElementById('detailedView').style.display = view === 'detailed' ? 'block' : 'none';
            document.getElementById('chaptersView').style.display = view === 'chapters' ? 'block' : 'none';
            
            if (view === 'overview') {
                updateOverviewChart();
            } else if (view === 'detailed') {
                renderDetailedTable();
                updateDetailedChart();
            } else if (view === 'chapters') {
                renderChapterCharts();
            }
        }

        function updateOverviewChart() {
            const data = [];
            const colors = {
                'Not Started': '#95a5a6',
                'In Progress': '#3498db',
                'Completed': '#27ae60',
                'Delayed': '#e74c3c'
            };
            
            const sortedChapters = [...chapters].reverse();
            
            sortedChapters.forEach((chapter, index) => {
                const startDate = new Date(chapter.startDate);
                const endDate = new Date(chapter.endDate);
                
                // Calculate chapter progress
                const chapterProgress = chapter.tasks.length > 0 ? 
                    Math.round(chapter.tasks.reduce((sum, t) => sum + t.progress, 0) / chapter.tasks.length) : 0;
                
                // Main progress bar
                data.push({
                    x: [startDate, endDate],
                    y: [index, index],
                    name: chapter.name,
                    text: `${chapter.name} (${chapterProgress}%)`,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: colors[chapter.status],
                        width: 30
                    },
                    hovertemplate: 
                        '<b>%{text}</b><br>' +
                        'Start: %{x[0]|%Y-%m-%d}<br>' +
                        'End: %{x[1]|%Y-%m-%d}<br>' +
                        'Tasks: ' + chapter.tasks.length + '<br>' +
                        'Progress: ' + chapterProgress + '%<br>' +
                        '<extra></extra>',
                    showlegend: false
                });
                
                // Progress bar
                if (chapterProgress > 0) {
                    const progressEnd = new Date(startDate.getTime() + (endDate - startDate) * chapterProgress / 100);
                    data.push({
                        x: [startDate, progressEnd],
                        y: [index, index],
                        type: 'scatter',
                        mode: 'lines',
                        line: {
                            color: '#2ecc71',
                            width: 15
                        },
                        hoverinfo: 'skip',
                        showlegend: false
                    });
                }
            });
            
            const layout = {
                title: {
                    text: 'PhD Thesis Chapters Progress Overview',
                    font: { size: 20, color: '#2c3e50' }
                },
                xaxis: {
                    type: 'date',
                    title: 'Date',
                    gridcolor: '#ecf0f1',
                    tickformat: '%Y-%m-%d'
                },
                yaxis: {
                    title: 'Chapters',
                    ticktext: sortedChapters.map(c => c.name),
                    tickvals: sortedChapters.map((c, i) => i),
                    tickmode: 'array',
                    gridcolor: '#ecf0f1'
                },
                height: 750,
                margin: { l: 250, r: 40, t: 60, b: 60 },
                hovermode: 'closest',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#fafafa',
                shapes: [{
                    type: 'line',
                    x0: new Date().toISOString().split('T')[0],
                    x1: new Date().toISOString().split('T')[0],
                    y0: -0.5,
                    y1: chapters.length - 0.5,
                    line: { color: '#e74c3c', width: 2, dash: 'dot' }
                }],
                annotations: [{
                    x: new Date().toISOString().split('T')[0],
                    y: chapters.length,
                    text: 'Today',
                    showarrow: true,
                    arrowhead: 2,
                    arrowcolor: '#e74c3c',
                    ax: 0,
                    ay: -30
                }]
            };
            
            Plotly.newPlot('overviewChart', data, layout, { responsive: true });
        }

        function updateDetailedChart() {
            const data = [];
            const colors = {
                'Not Started': '#95a5a6',
                'In Progress': '#3498db',
                'Completed': '#27ae60',
                'Delayed': '#e74c3c'
            };
            
            const allTasks = [];
            chapters.forEach(chapter => {
                chapter.tasks.forEach(task => {
                    allTasks.push({
                        ...task,
                        chapterName: chapter.name
                    });
                });
            });
            
            allTasks.reverse().forEach((task, index) => {
                const startDate = new Date(task.startDate);
                const endDate = new Date(task.endDate);
                
                data.push({
                    x: [startDate, endDate],
                    y: [index, index],
                    name: task.name,
                    text: `${task.name} (${task.progress}%)`,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: colors[task.status],
                        width: 15
                    },
                    hovertemplate: 
                        '<b>%{text}</b><br>' +
                        'Chapter: ' + task.chapterName + '<br>' +
                        'Start: %{x[0]|%Y-%m-%d}<br>' +
                        'End: %{x[1]|%Y-%m-%d}<br>' +
                        'Progress: ' + task.progress + '%<br>' +
                        'Status: ' + task.status +
                        '<extra></extra>',
                    showlegend: false
                });
                
                if (task.progress > 0) {
                    const progressEnd = new Date(startDate.getTime() + (endDate - startDate) * task.progress / 100);
                    data.push({
                        x: [startDate, progressEnd],
                        y: [index, index],
                        type: 'scatter',
                        mode: 'lines',
                        line: {
                            color: '#2ecc71',
                            width: 8
                        },
                        hoverinfo: 'skip',
                        showlegend: false
                    });
                }
            });
            
            const layout = {
                title: {
                    text: 'All Tasks Detailed Progress',
                    font: { size: 20, color: '#2c3e50' }
                },
                xaxis: {
                    type: 'date',
                    title: 'Date',
                    gridcolor: '#ecf0f1',
                    tickformat: '%m/%d'
                },
                yaxis: {
                    title: 'Tasks',
                    ticktext: allTasks.reverse().map(t => t.name.substring(0, 30) + '...'),
                    tickvals: allTasks.map((t, i) => i),
                    tickmode: 'array',
                    gridcolor: '#ecf0f1'
                },
                height: 750,
                margin: { l: 200, r: 40, t: 60, b: 60 },
                hovermode: 'closest',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#fafafa'
            };
            
            Plotly.newPlot('detailedChart', data, layout, { responsive: true });
        }

        function renderDetailedTable() {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            
            chapters.forEach((chapter, chapterIndex) => {
                // Chapter row
                const chapterRow = tbody.insertRow();
                chapterRow.className = 'chapter-row';
                chapterRow.innerHTML = `
                    <td class="checkbox-cell"><input type="checkbox" data-chapter="${chapterIndex}"></td>
                    <td>
                        <button class="collapse-btn" onclick="toggleChapter(${chapterIndex})">
                            ${chapter.expanded ? '‚ñº' : '‚ñ∂'}
                        </button>
                        <input type="text" value="${chapter.name}" onchange="updateChapter(${chapterIndex}, 'name', this.value)" style="width: 80%; font-weight: bold;">
                    </td>
                    <td><input type="date" value="${chapter.startDate}" onchange="updateChapter(${chapterIndex}, 'startDate', this.value)"></td>
                    <td><input type="date" value="${chapter.endDate}" onchange="updateChapter(${chapterIndex}, 'endDate', this.value)"></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${calculateChapterProgress(chapter)}%">
                                ${calculateChapterProgress(chapter)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateChapter(${chapterIndex}, 'status', this.value)">
                            <option value="Not Started" ${chapter.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                            <option value="In Progress" ${chapter.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${chapter.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Delayed" ${chapter.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                        </select>
                    </td>
                    <td>
                        <button onclick="addTask(${chapterIndex})">‚ûï Add Task</button>
                    </td>
                `;
                
                // Task rows
                if (chapter.expanded) {
                    chapter.tasks.forEach((task, taskIndex) => {
                        const taskRow = tbody.insertRow();
                        taskRow.className = 'task-row';
                        taskRow.innerHTML = `
                            <td class="checkbox-cell"><input type="checkbox" data-chapter="${chapterIndex}" data-task="${taskIndex}"></td>
                            <td><input type="text" value="${task.name}" onchange="updateTask(${chapterIndex}, ${taskIndex}, 'name', this.value)"></td>
                            <td><input type="date" value="${task.startDate}" onchange="updateTask(${chapterIndex}, ${taskIndex}, 'startDate', this.value)"></td>
                            <td><input type="date" value="${task.endDate}" onchange="updateTask(${chapterIndex}, ${taskIndex}, 'endDate', this.value)"></td>
                            <td><input type="number" min="0" max="100" value="${task.progress}" onchange="updateTask(${chapterIndex}, ${taskIndex}, 'progress', this.value)"></td>
                            <td>
                                <select onchange="updateTask(${chapterIndex}, ${taskIndex}, 'status', this.value)">
                                    <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                    <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Delayed" ${task.status === 'Delayed' ? 'selected' : ''}>Delayed</option>
                                </select>
                            </td>
                            <td>
                                <button onclick="deleteTask(${chapterIndex}, ${taskIndex})">üóëÔ∏è</button>
                            </td>
                        `;
                    });
                }
            });
            
            updateStats();
        }

        function renderChapterCharts() {
            const container = document.getElementById('chapterCharts');
            container.innerHTML = '';
            
            chapters.forEach((chapter, index) => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chapter-chart';
                chartDiv.innerHTML = `
                    <h3>${chapter.name}</h3>
                    <div id="chapterChart${index}" style="height: 400px;"></div>
                `;
                container.appendChild(chartDiv);
                
                // Draw gantt chart for individual chapter
                updateChapterChart(chapter, index);
            });
        }

        function updateChapterChart(chapter, chapterIndex) {
            const data = [];
            const colors = {
                'Not Started': '#95a5a6',
                'In Progress': '#3498db',
                'Completed': '#27ae60',
                'Delayed': '#e74c3c'
            };
            
            const reversedTasks = [...chapter.tasks].reverse();
            
            reversedTasks.forEach((task, index) => {
                const startDate = new Date(task.startDate);
                const endDate = new Date(task.endDate);
                
                data.push({
                    x: [startDate, endDate],
                    y: [index, index],
                    name: task.name,
                    text: `${task.name} (${task.progress}%)`,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: colors[task.status],
                        width: 20
                    },
                    hovertemplate: 
                        '<b>%{text}</b><br>' +
                        'Start: %{x[0]|%Y-%m-%d}<br>' +
                        'End: %{x[1]|%Y-%m-%d}<br>' +
                        'Progress: ' + task.progress + '%<br>' +
                        'Status: ' + task.status +
                        '<extra></extra>',
                    showlegend: false
                });
                
                if (task.progress > 0) {
                    const progressEnd = new Date(startDate.getTime() + (endDate - startDate) * task.progress / 100);
                    data.push({
                        x: [startDate, progressEnd],
                        y: [index, index],
                        type: 'scatter',
                        mode: 'lines',
                        line: {
                            color: '#2ecc71',
                            width: 10
                        },
                        hoverinfo: 'skip',
                        showlegend: false
                    });
                }
            });
            
            const layout = {
                xaxis: {
                    type: 'date',
                    title: 'Date',
                    gridcolor: '#ecf0f1',
                    tickformat: '%m/%d'
                },
                yaxis: {
                    ticktext: reversedTasks.map(t => t.name.length > 25 ? t.name.substring(0, 25) + '...' : t.name),
                    tickvals: reversedTasks.map((t, i) => i),
                    tickmode: 'array',
                    gridcolor: '#ecf0f1'
                },
                height: 350,
                margin: { l: 180, r: 20, t: 30, b: 40 },
                hovermode: 'closest',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#fafafa'
            };
            
            Plotly.newPlot(`chapterChart${chapterIndex}`, data, layout, { responsive: true });
        }

        function calculateChapterProgress(chapter) {
            if (chapter.tasks.length === 0) return 0;
            const totalProgress = chapter.tasks.reduce((sum, task) => sum + parseInt(task.progress || 0), 0);
            return Math.round(totalProgress / chapter.tasks.length);
        }

        function updateStats() {
            const totalTasks = chapters.reduce((sum, ch) => sum + ch.tasks.length, 0);
            const completedTasks = chapters.reduce((sum, ch) => 
                sum + ch.tasks.filter(t => t.status === 'Completed').length, 0);
            const overallProgress = totalTasks > 0 ? 
                Math.round(chapters.reduce((sum, ch) => 
                    sum + ch.tasks.reduce((tSum, t) => tSum + parseInt(t.progress || 0), 0), 0) / totalTasks) : 0;
            
            document.getElementById('totalChapters').textContent = chapters.length;
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('avgProgress').textContent = overallProgress + '%';
        }

        function toggleChapter(index) {
            chapters[index].expanded = !chapters[index].expanded;
            renderDetailedTable();
        }

        function expandAll() {
            chapters.forEach(ch => ch.expanded = true);
            renderDetailedTable();
        }

        function collapseAll() {
            chapters.forEach(ch => ch.expanded = false);
            renderDetailedTable();
        }

        function updateChapter(index, field, value) {
            chapters[index][field] = value;
            if (currentView === 'detailed') {
                renderDetailedTable();
            }
            updateAllCharts();
        }

        function updateTask(chapterIndex, taskIndex, field, value) {
            if (field === 'progress') {
                value = Math.max(0, Math.min(100, parseInt(value) || 0));
                if (value === 0) {
                    chapters[chapterIndex].tasks[taskIndex].status = 'Not Started';
                } else if (value === 100) {
                    chapters[chapterIndex].tasks[taskIndex].status = 'Completed';
                } else {
                    chapters[chapterIndex].tasks[taskIndex].status = 'In Progress';
                }
            }
            chapters[chapterIndex].tasks[taskIndex][field] = value;
            
            // Update chapter status
            const chapterProgress = calculateChapterProgress(chapters[chapterIndex]);
            if (chapterProgress === 0) {
                chapters[chapterIndex].status = 'Not Started';
            } else if (chapterProgress === 100) {
                chapters[chapterIndex].status = 'Completed';
            } else {
                chapters[chapterIndex].status = 'In Progress';
            }
            
            if (currentView === 'detailed') {
                renderDetailedTable();
            }
            updateAllCharts();
        }

        function addChapter() {
            const newChapter = {
                id: 'ch' + Date.now(),
                name: 'New Chapter',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                progress: 0,
                status: 'Not Started',
                expanded: true,
                tasks: []
            };
            chapters.push(newChapter);
            if (currentView === 'detailed') {
                renderDetailedTable();
            }
            updateAllCharts();
        }

        function addTask(chapterIndex) {
            const chapter = chapters[chapterIndex];
            const lastTaskDate = chapter.tasks.length > 0 ? 
                chapter.tasks[chapter.tasks.length - 1].endDate : chapter.startDate;
            
            const newTask = {
                name: 'New Task',
                startDate: lastTaskDate,
                endDate: lastTaskDate,
                progress: 0,
                status: 'Not Started'
            };
            
            chapter.tasks.push(newTask);
            if (currentView === 'detailed') {
                renderDetailedTable();
            }
            updateAllCharts();
        }

        function deleteTask(chapterIndex, taskIndex) {
            if (confirm('Are you sure you want to delete this task?')) {
                chapters[chapterIndex].tasks.splice(taskIndex, 1);
                if (currentView === 'detailed') {
                    renderDetailedTable();
                }
                updateAllCharts();
            }
        }

        function updateAllCharts() {
            if (currentView === 'overview') {
                updateOverviewChart();
            } else if (currentView === 'detailed') {
                updateDetailedChart();
            } else if (currentView === 'chapters') {
                renderChapterCharts();
            }
            updateStats();
        }

        function exportData() {
            const dataStr = JSON.stringify(chapters, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `PhD_Timeline_Detailed_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        chapters = JSON.parse(e.target.result);
                        updateAllCharts();
                        if (currentView === 'detailed') {
                            renderDetailedTable();
                        }
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Import failed: Invalid file format');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize
        updateOverviewChart();
        updateStats();
        
        // Auto save
        setInterval(() => {
            localStorage.setItem('phdDetailedTasks', JSON.stringify(chapters));
        }, 5000);
        
        // Load saved data
        window.addEventListener('load', () => {
            const savedData = localStorage.getItem('phdDetailedTasks');
            if (savedData) {
                try {
                    chapters = JSON.parse(savedData);
                    updateAllCharts();
                } catch (e) {
                    console.log('Failed to load saved data');
                }
            }
        });
    </script>
</body>
</html>